<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #111217; 
            color: #d8d9da; 
            min-height: 100vh;
        }
        
        /* Navigation */
        .top-nav {
            background: #1f1f1f;
            border-bottom: 1px solid #343436;
            padding: 0 16px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .top-nav .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #ff9830;
        }
        .nav-links { display: flex; gap: 4px; }
        .nav-links a {
            padding: 8px 16px;
            color: #d8d9da;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .nav-links a:hover { background: #2c2c2e; }
        .nav-links a.active { background: #3871dc; color: white; }
        .nav-links a.logout { background: rgba(239,68,68,0.3); }
        .nav-links a.logout:hover { background: rgba(239,68,68,0.5); }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .nyse-time {
            text-align: right;
            padding: 4px 12px;
            background: #262628;
            border-radius: 4px;
        }
        .nyse-time .time-value { font-size: 16px; font-weight: 600; font-family: monospace; }
        .nyse-time .time-date { font-size: 11px; color: #8e8e8e; }
        
        .refresh-indicator { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #8e8e8e; }
        .refresh-indicator .dot { width: 8px; height: 8px; background: #73bf69; border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        /* Dashboard Layout */
        .dashboard { padding: 16px; }
        .row { display: grid; gap: 8px; margin-bottom: 8px; }
        .row-4 { grid-template-columns: repeat(4, 1fr); }
        .row-3 { grid-template-columns: repeat(3, 1fr); }
        .row-2 { grid-template-columns: repeat(2, 1fr); }
        @media (max-width: 1200px) { .row-4 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .row-4, .row-3, .row-2 { grid-template-columns: 1fr; } }
        
        /* Panels */
        .panel {
            background: #1f1f1f;
            border: 1px solid #343436;
            border-radius: 4px;
            overflow: hidden;
        }
        .panel-header {
            background: #262628;
            padding: 8px 16px;
            border-bottom: 1px solid #343436;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title { font-size: 14px; font-weight: 500; }
        .panel-body { padding: 16px; }
        .panel-body.stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }
        
        .stat-value { font-size: 36px; font-weight: 300; line-height: 1; margin-bottom: 6px; }
        .stat-label { font-size: 12px; color: #8e8e8e; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Colors */
        .green { color: #73bf69; }
        .red { color: #f2495c; }
        .yellow { color: #ff9830; }
        .blue { color: #5794f2; }
        .purple { color: #b877d9; }
        
        /* Status indicators */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.open { background: rgba(115, 191, 105, 0.2); color: #73bf69; }
        .status-badge.closed { background: rgba(242, 73, 92, 0.2); color: #f2495c; }
        .status-badge.running { background: rgba(115, 191, 105, 0.2); color: #73bf69; }
        .status-badge.stopped { background: rgba(142, 142, 142, 0.2); color: #8e8e8e; }
        
        /* Regime badge */
        .regime-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .regime-bull, .regime-strong_bull { background: rgba(115, 191, 105, 0.2); color: #73bf69; }
        .regime-bear, .regime-strong_bear { background: rgba(242, 73, 92, 0.2); color: #f2495c; }
        .regime-neutral { background: rgba(142, 142, 142, 0.2); color: #8e8e8e; }
        .regime-high_volatility { background: rgba(184, 119, 217, 0.2); color: #b877d9; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: #262628;
            color: #8e8e8e;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        .data-table td { padding: 10px 12px; border-top: 1px solid #343436; }
        .data-table tr:hover { background: #262628; }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #3871dc; color: white; }
        .btn-primary:hover { background: #4a8af4; }
        .btn-success { background: #56a64b; color: white; }
        .btn-success:hover { background: #73bf69; }
        .btn-danger { background: #c4162a; color: white; }
        .btn-danger:hover { background: #f2495c; }
        .btn-secondary { background: #3d3d3d; color: #d8d9da; }
        .btn-secondary:hover { background: #4d4d4d; }
        
        /* Log container */
        .log-container {
            max-height: 350px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            background: #181b1f;
            border-radius: 4px;
            padding: 12px;
        }
        .log-entry {
            padding: 6px 10px;
            margin-bottom: 4px;
            border-left: 3px solid #343436;
            background: #1f1f1f;
            border-radius: 0 4px 4px 0;
        }
        .log-entry.info { border-left-color: #5794f2; }
        .log-entry.error { border-left-color: #f2495c; background: rgba(242, 73, 92, 0.1); }
        .log-entry .timestamp { color: #6e6e6e; font-size: 11px; }
        
        /* Ticker link */
        .ticker-link { color: #5794f2; text-decoration: none; cursor: pointer; font-weight: 600; }
        .ticker-link:hover { text-decoration: underline; }
        
        /* Empty state */
        .empty { text-align: center; padding: 40px; color: #6e6e6e; }
        
        /* Flash animations */
        .flash-green { animation: flashGreen 0.5s ease; }
        .flash-red { animation: flashRed 0.5s ease; }
        @keyframes flashGreen { 0% { background: rgba(115, 191, 105, 0.3); } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: rgba(242, 73, 92, 0.3); } 100% { background: transparent; } }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: #1f1f1f;
            border: 1px solid #343436;
            border-radius: 8px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
        }
        .modal-header {
            background: #262628;
            padding: 16px 20px;
            border-bottom: 1px solid #343436;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 18px; font-weight: 500; }
        .modal-header .close-btn {
            background: #3d3d3d;
            border: none;
            color: #d8d9da;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-header .close-btn:hover { background: #4d4d4d; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 70px); }
        
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .detail-card { background: #181b1f; border: 1px solid #343436; border-radius: 4px; padding: 14px; }
        .detail-card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #8e8e8e; margin-bottom: 4px; }
        .detail-card .value { font-size: 20px; font-weight: 500; }
        .detail-card .sub { font-size: 12px; color: #6e6e6e; margin-top: 2px; }
        
        .section-box { background: #181b1f; border: 1px solid #343436; border-radius: 4px; padding: 16px; margin-bottom: 12px; }
        .section-box h3 { font-size: 14px; margin-bottom: 10px; color: #8e8e8e; border-bottom: 1px solid #343436; padding-bottom: 8px; }
        .section-box .content { font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
        
        .chart-container { background: #181b1f; border: 1px solid #343436; border-radius: 4px; padding: 12px; margin-bottom: 12px; }
        .chart-container h3 { font-size: 14px; margin-bottom: 10px; color: #8e8e8e; }
        
        /* News cards */
        .news-container { max-height: 280px; overflow-y: auto; }
        .news-card { background: #262628; border-radius: 4px; padding: 12px; margin-bottom: 8px; border-left: 3px solid #5794f2; }
        .news-card:hover { background: #2c2c2e; }
        .news-card .news-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .news-card .news-title a { color: #5794f2; text-decoration: none; }
        .news-card .news-title a:hover { text-decoration: underline; }
        .news-card .news-desc { font-size: 12px; color: #8e8e8e; margin-bottom: 6px; line-height: 1.4; }
        .news-card .news-meta { font-size: 11px; color: #6e6e6e; display: flex; gap: 12px; }
        
        /* Price bar */
        .price-bar { flex: 1; height: 8px; background: #343436; border-radius: 4px; position: relative; overflow: hidden; }
        .price-marker { position: absolute; width: 4px; height: 100%; border-radius: 2px; }
        .price-marker.stop { background: #f2495c; }
        .price-marker.current { background: #5794f2; }
        .price-marker.target { background: #73bf69; }
        
        /* Controls section */
        .controls-bar {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #181b1f;
            border-bottom: 1px solid #343436;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            background: #1f1f1f;
            border: 1px solid #343436;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 13px;
        }
        .notification.show { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notification.success { border-left: 3px solid #73bf69; }
        .notification.error { border-left: 3px solid #f2495c; }
        .notification.info { border-left: 3px solid #5794f2; }
    </style>
</head>
<body>
    <!-- Position Detail Modal -->
    <div class="modal-overlay" id="position-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="modal-symbol">AAPL</span> Position Details</h2>
                <button class="close-btn" onclick="closePositionModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="empty">Loading...</div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            AI Trading System
        </div>
        <div class="nav-links">
            <a href="/" class="active">Dashboard</a>
            <a href="/analysis">Analysis</a>
            <a href="/performance">Performance</a>
            <a href="/optimizer">Optimizer</a>
            <a href="/metrics-view">Metrics</a>
            <a href="/grafana">Grafana</a>
            <a href="/logout" class="logout">Logout</a>
        </div>
        <div class="nav-right">
            <div class="nyse-time">
                <div class="time-value" id="nyse-time">--:--:-- --</div>
                <div class="time-date" id="nyse-date">---</div>
            </div>
            <div class="refresh-indicator">
                <div class="dot"></div>
                <span>Live</span>
            </div>
        </div>
    </nav>

    <!-- Controls Bar -->
    <div class="controls-bar">
        <span style="color: #8e8e8e; margin-right: 8px;">Market:</span>
        <span class="status-badge" id="market-status">Loading...</span>
        <span style="color: #6e6e6e; margin: 0 12px;">|</span>
        <span style="color: #8e8e8e; margin-right: 8px;">Bot:</span>
        <span class="status-badge" id="trading-status">Checking...</span>
        <span style="color: #6e6e6e; margin: 0 12px;">|</span>
        <span style="color: #8e8e8e; margin-right: 8px;">Regime:</span>
        <span class="regime-badge" id="regime-badge">--</span>
        <span id="regime-params" style="color: #6e6e6e; font-size: 12px; margin-left: 8px;">SL: --% | TP: --% | Min: --</span>
    </div>

    <div class="dashboard">
        <!-- Row 1: Key Stats -->
        <div class="row row-4">
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Portfolio Value</span></div>
                <div class="panel-body stat">
                    <div class="stat-value green" id="portfolio-value">$0</div>
                    <div class="stat-label">Total Equity</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Buying Power</span></div>
                <div class="panel-body stat">
                    <div class="stat-value blue" id="buying-power">$0</div>
                    <div class="stat-label">Available</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Cash</span></div>
                <div class="panel-body stat">
                    <div class="stat-value" id="cash">$0</div>
                    <div class="stat-label">Uninvested</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Today's P&L</span></div>
                <div class="panel-body stat">
                    <div class="stat-value" id="profit-loss">$0</div>
                    <div class="stat-label" id="profit-loss-pct">0.00%</div>
                </div>
            </div>
        </div>

        <!-- Row 2: Rebalancing & Premarket -->
        <div class="row row-2">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üîÑ Rebalancing Stats</span>
                    <button class="btn btn-secondary" onclick="showRebalancingHistory()" style="padding: 4px 10px; font-size: 11px;">View History</button>
                </div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">TOTAL</div>
                            <div style="font-size: 24px; font-weight: 500;" id="rebal-total">0</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">AVG IMPROVEMENT</div>
                            <div style="font-size: 24px; font-weight: 500; color: #73bf69;" id="rebal-avg">+0.0</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">CAN REBALANCE</div>
                            <div style="font-size: 24px; font-weight: 500;" id="rebal-status-icon">‚è≥</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">COOLDOWN</div>
                            <div style="font-size: 24px; font-weight: 500;" id="rebal-cooldown">60m</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üåÖ Premarket Candidates</span>
                    <span id="premarket-scan-time" style="font-size: 11px; color: #6e6e6e;"></span>
                </div>
                <div class="panel-body" id="premarket-candidates" style="max-height: 150px; overflow-y: auto;">
                    <div class="empty">No premarket candidates</div>
                </div>
            </div>
        </div>

        <!-- Row 3: Premarket Stats -->
        <div class="panel" style="margin-bottom: 8px;">
            <div class="panel-header">
                <span class="panel-title">üìä Premarket Performance</span>
                <button class="btn btn-secondary" onclick="showPremarketHistory()" style="padding: 4px 10px; font-size: 11px;">View History</button>
            </div>
            <div class="panel-body">
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; text-align: center;">
                    <div>
                        <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">DAYS</div>
                        <div style="font-size: 24px; font-weight: 500;" id="pm-total-days">0</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">EXECUTED</div>
                        <div style="font-size: 24px; font-weight: 500;" id="pm-total-executed">0</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">WIN RATE</div>
                        <div style="font-size: 24px; font-weight: 500; color: #73bf69;" id="pm-win-rate">0%</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">AVG P/L</div>
                        <div style="font-size: 24px; font-weight: 500;" id="pm-avg-pl">0%</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">BEST</div>
                        <div style="font-size: 18px; font-weight: 500; color: #73bf69;" id="pm-best-trade">-</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #8e8e8e; margin-bottom: 4px;">WORST</div>
                        <div style="font-size: 18px; font-weight: 500; color: #f2495c;" id="pm-worst-trade">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Positions -->
        <div class="panel" style="margin-bottom: 8px;">
            <div class="panel-header">
                <span class="panel-title">üìä Open Positions</span>
                <span id="positions-updated" style="font-size: 11px; color: #6e6e6e;"></span>
            </div>
            <div class="panel-body" style="padding: 0;">
                <div id="positions-table"></div>
            </div>
        </div>

        <!-- Row 5: Orders -->
        <div class="panel" style="margin-bottom: 8px;">
            <div class="panel-header">
                <span class="panel-title">üìù Recent Orders</span>
            </div>
            <div class="panel-body" style="padding: 0; max-height: 300px; overflow-y: auto;">
                <div id="orders-table"></div>
            </div>
        </div>

        <!-- Row 6: Logs -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üìã Activity Log</span>
            </div>
            <div class="panel-body" style="padding: 12px;">
                <div class="log-container" id="log-container"></div>
            </div>
        </div>
    </div>

    <script>
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show ' + type;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }

        function formatPercent(value) {
            return (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        let previousAccount = {};

        async function updateStatus() {
            const data = await fetchData('/api/status');
            if (!data) return;

            // Market status
            const marketEl = document.getElementById('market-status');
            if (data.market && data.market.is_open) {
                marketEl.textContent = '‚óè OPEN';
                marketEl.className = 'status-badge open';
            } else {
                marketEl.textContent = '‚óè CLOSED';
                marketEl.className = 'status-badge closed';
            }

            // Bot status
            const botEl = document.getElementById('trading-status');
            if (data.trading_running) {
                botEl.textContent = '‚óè RUNNING';
                botEl.className = 'status-badge running';
            } else {
                botEl.textContent = '‚óè STOPPED';
                botEl.className = 'status-badge stopped';
            }

            // Regime
            if (data.regime) {
                const regimeBadge = document.getElementById('regime-badge');
                const regimeName = (data.regime.regime || 'unknown').toUpperCase().replace('_', ' ');
                regimeBadge.textContent = regimeName;
                regimeBadge.className = 'regime-badge regime-' + (data.regime.regime || 'neutral');
                
                const slPct = ((data.regime.stop_loss_pct || 0.03) * 100).toFixed(0);
                const tpPct = ((data.regime.take_profit_pct || 0.08) * 100).toFixed(0);
                const minScore = data.regime.min_score || 70;
                document.getElementById('regime-params').textContent = `SL: ${slPct}% | TP: ${tpPct}% | Min: ${minScore}`;
            }

            // Account
            const account = data.account;
            if (account) {
                const portfolioEl = document.getElementById('portfolio-value');
                if (previousAccount.portfolio_value !== undefined && previousAccount.portfolio_value !== account.portfolio_value) {
                    portfolioEl.classList.remove('flash-green', 'flash-red');
                    void portfolioEl.offsetWidth;
                    portfolioEl.classList.add(account.portfolio_value > previousAccount.portfolio_value ? 'flash-green' : 'flash-red');
                }
                portfolioEl.textContent = formatCurrency(account.portfolio_value);
                
                document.getElementById('buying-power').textContent = formatCurrency(account.buying_power);
                document.getElementById('cash').textContent = formatCurrency(account.cash);
                
                const plEl = document.getElementById('profit-loss');
                plEl.textContent = formatCurrency(account.profit_loss);
                plEl.className = 'stat-value ' + (account.profit_loss >= 0 ? 'green' : 'red');
                
                const plPctEl = document.getElementById('profit-loss-pct');
                plPctEl.textContent = formatPercent(account.profit_loss_pct);
                plPctEl.className = 'stat-label ' + (account.profit_loss >= 0 ? 'green' : 'red');
                
                previousAccount = { portfolio_value: account.portfolio_value, profit_loss: account.profit_loss };
            }
        }

        let previousPositions = {};

        async function updatePositions() {
            const positions = await fetchData('/api/positions');
            if (!positions) return;

            const container = document.getElementById('positions-table');
            
            if (positions.length === 0) {
                container.innerHTML = '<div class="empty">No open positions</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>Symbol</th><th>Qty</th><th>Entry</th><th>Current</th><th>Value</th><th>P&L</th><th>P&L %</th><th>Hold</th><th>Lock</th></tr></thead><tbody>';
            
            for (const pos of positions) {
                const plClass = pos.unrealized_pl >= 0 ? 'green' : 'red';
                const lockIcon = pos.is_locked ? 'üîí' : 'üîì';
                const lockClass = pos.is_locked ? 'btn-danger' : 'btn-success';
                const holdTime = pos.hold_duration_min ? `${Math.floor(pos.hold_duration_min / 60)}h ${pos.hold_duration_min % 60}m` : '-';
                
                html += `<tr>
                    <td><a class="ticker-link" onclick="showPositionDetails('${pos.symbol}')">${pos.symbol}</a></td>
                    <td>${pos.qty}</td>
                    <td>${formatCurrency(pos.avg_entry_price)}</td>
                    <td>${formatCurrency(pos.current_price)}</td>
                    <td>${formatCurrency(pos.market_value)}</td>
                    <td class="${plClass}">${formatCurrency(pos.unrealized_pl)}</td>
                    <td class="${plClass}">${formatPercent(pos.unrealized_plpc)}</td>
                    <td>${holdTime}</td>
                    <td><button class="btn ${lockClass}" onclick="toggleLock('${pos.symbol}')" style="padding: 4px 8px; font-size: 11px;">${lockIcon}</button></td>
                </tr>`;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('positions-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        }

        async function updateOrders() {
            const orders = await fetchData('/api/orders');
            if (!orders) return;

            const container = document.getElementById('orders-table');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="empty">No recent orders</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Type</th><th>Status</th><th>Filled</th><th>Price</th><th>Time</th></tr></thead><tbody>';
            
            for (const order of orders.slice(0, 10)) {
                const sideClass = order.side === 'buy' ? 'green' : 'red';
                const statusClass = order.status === 'filled' ? 'green' : order.status === 'rejected' ? 'red' : 'yellow';
                
                html += `<tr>
                    <td><a class="ticker-link" onclick="showSymbolDetails('${order.symbol}')">${order.symbol}</a></td>
                    <td class="${sideClass}" style="text-transform: uppercase; font-weight: 600;">${order.side}</td>
                    <td>${order.qty}</td>
                    <td>${order.type}</td>
                    <td class="${statusClass}">${order.status}</td>
                    <td>${order.filled_qty}</td>
                    <td>${order.filled_avg_price > 0 ? '$' + order.filled_avg_price.toFixed(2) : '-'}</td>
                    <td style="color: #6e6e6e;">${new Date(order.created_at).toLocaleTimeString()}</td>
                </tr>`;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function updateLogs() {
            const logs = await fetchData('/api/logs');
            if (!logs) return;

            const container = document.getElementById('log-container');
            let html = '';
            
            for (const log of logs.slice(-30)) {
                const level = log.level || 'info';
                const event = log.event || 'unknown';
                const timestamp = log.timestamp || new Date().toISOString();
                
                html = `<div class="log-entry ${level}">
                    <div class="timestamp">${new Date(timestamp).toLocaleTimeString()}</div>
                    <div>${event}: ${JSON.stringify(log).substring(0, 150)}${JSON.stringify(log).length > 150 ? '...' : ''}</div>
                </div>` + html;
            }
            
            container.innerHTML = html || '<div class="empty">No logs yet</div>';
        }

        async function updateRebalancingStats() {
            const data = await fetchData('/api/rebalancing/stats');
            if (!data || data.error) return;

            document.getElementById('rebal-total').textContent = data.total_rebalances;
            document.getElementById('rebal-avg').textContent = data.avg_score_improvement ? `+${data.avg_score_improvement.toFixed(1)}` : '+0.0';
            document.getElementById('rebal-cooldown').textContent = `${data.cooldown_minutes}m`;
            document.getElementById('rebal-status-icon').textContent = data.can_rebalance_now ? '‚úÖ' : '‚è≥';
            document.getElementById('rebal-status-icon').style.color = data.can_rebalance_now ? '#73bf69' : '#ff9830';
        }

        async function updatePremarketCandidates() {
            const data = await fetchData('/api/premarket/candidates');
            if (!data) return;

            const container = document.getElementById('premarket-candidates');
            const scanTimeEl = document.getElementById('premarket-scan-time');
            
            if (data.scan_time) {
                const scanDate = new Date(data.scan_time);
                scanTimeEl.textContent = data.is_today ? `Scanned ${scanDate.toLocaleTimeString()}` : `Stale: ${scanDate.toLocaleDateString()}`;
                scanTimeEl.style.color = data.is_today ? '#73bf69' : '#ff9830';
            }

            if (!data.candidates || data.candidates.length === 0) {
                container.innerHTML = '<div class="empty" style="padding: 20px;">No premarket candidates</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>#</th><th>Symbol</th><th>Score</th><th>Price</th></tr></thead><tbody>';
            data.candidates.slice(0, 5).forEach((c, i) => {
                const scoreClass = c.score >= 75 ? 'green' : c.score >= 70 ? 'yellow' : 'red';
                html += `<tr><td>${i + 1}</td><td><strong>${c.symbol}</strong></td><td class="${scoreClass}">${c.score.toFixed(1)}</td><td>${c.price ? '$' + c.price.toFixed(2) : '-'}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function updatePremarketStats() {
            const stats = await fetchData('/api/premarket/stats');
            if (!stats || stats.error) return;

            document.getElementById('pm-total-days').textContent = stats.total_days;
            document.getElementById('pm-total-executed').textContent = stats.total_executed;
            document.getElementById('pm-win-rate').textContent = `${stats.win_rate}%`;
            document.getElementById('pm-win-rate').className = stats.win_rate >= 50 ? 'green' : 'red';
            
            const avgPl = stats.avg_profit_pct;
            document.getElementById('pm-avg-pl').textContent = `${avgPl >= 0 ? '+' : ''}${avgPl}%`;
            document.getElementById('pm-avg-pl').style.color = avgPl >= 0 ? '#73bf69' : '#f2495c';
            
            if (stats.best_trade) {
                document.getElementById('pm-best-trade').textContent = `${stats.best_trade.symbol} +${stats.best_trade.profit_pct.toFixed(1)}%`;
            }
            if (stats.worst_trade) {
                document.getElementById('pm-worst-trade').textContent = `${stats.worst_trade.symbol} ${stats.worst_trade.profit_pct.toFixed(1)}%`;
            }
        }

        async function toggleLock(symbol) {
            const positions = await fetchData('/api/positions');
            const position = positions.find(p => p.symbol === symbol);
            const isLocked = position ? position.is_locked : false;
            
            const action = isLocked ? 'unlock' : 'lock';
            showNotification(`${isLocked ? 'Unlocking' : 'Locking'} ${symbol}...`, 'info');
            
            const result = await fetchData(`/api/positions/${action}/${symbol}`, { method: 'POST' });
            
            if (result && result.status === 'success') {
                showNotification(result.message, 'success');
                await updatePositions();
            } else {
                showNotification(`Failed to ${action} ${symbol}`, 'error');
            }
        }

        async function showRebalancingHistory() {
            const history = await fetchData('/api/rebalancing/history?limit=20');
            if (!history || history.length === 0) {
                showNotification('No rebalancing history available', 'info');
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Time</th><th>Old</th><th>Score</th><th>New</th><th>Score</th><th>Gain</th></tr></thead><tbody>';
            for (const event of history) {
                const improvement = event.new_score - event.old_score;
                html += `<tr><td>${new Date(event.timestamp).toLocaleString()}</td><td>${event.old_symbol}</td><td>${event.old_score.toFixed(1)}</td><td>${event.new_symbol}</td><td>${event.new_score.toFixed(1)}</td><td class="green">+${improvement.toFixed(1)}</td></tr>`;
            }
            html += '</tbody></table>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Rebalancing History</h2><button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button></div><div class="modal-body">${html}</div></div>`;
            document.body.appendChild(modal);
        }

        async function showPremarketHistory() {
            const history = await fetchData('/api/premarket/history?limit=30');
            if (!history || history.length === 0) {
                showNotification('No premarket history available', 'info');
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Date</th><th>Regime</th><th>Candidates</th><th>Executed</th><th>Trades</th></tr></thead><tbody>';
            for (const record of history) {
                let tradesHtml = (record.executed || []).map(t => {
                    const hasPL = 'profit_loss_pct' in t;
                    const plClass = hasPL ? (t.profit_loss_pct >= 0 ? 'green' : 'red') : '';
                    return `<span class="${plClass}">${t.symbol}: ${hasPL ? (t.profit_loss_pct >= 0 ? '+' : '') + t.profit_loss_pct.toFixed(1) + '%' : 'Open'}</span>`;
                }).join(' ');
                html += `<tr><td>${record.date}</td><td>${(record.regime || 'unknown').toUpperCase()}</td><td>${record.total_candidates}</td><td>${record.execution_count}</td><td style="font-size: 11px;">${tradesHtml || '-'}</td></tr>`;
            }
            html += '</tbody></table>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `<div class="modal-content" style="max-width: 1000px;"><div class="modal-header"><h2>Premarket History</h2><button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button></div><div class="modal-body">${html}</div></div>`;
            document.body.appendChild(modal);
        }

        async function showPositionDetails(symbol) {
            const modal = document.getElementById('position-modal');
            const modalBody = document.getElementById('modal-body');
            document.getElementById('modal-symbol').textContent = symbol;
            modalBody.innerHTML = '<div class="empty">Loading...</div>';
            modal.classList.add('active');
            
            try {
                const data = await fetchData(`/api/positions/${symbol}/details`);
                if (!data || data.error) {
                    modalBody.innerHTML = `<div class="empty" style="color: #f2495c;">Error: ${data?.error || 'Failed to load'}</div>`;
                    return;
                }
                
                const plClass = data.unrealized_pl >= 0 ? 'green' : 'red';
                const priceRange = data.take_profit_price - data.stop_loss_price;
                const pricePosition = Math.max(0, Math.min(100, ((data.current_price - data.stop_loss_price) / priceRange) * 100));
                
                modalBody.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-card"><div class="label">Entry Price</div><div class="value">${formatCurrency(data.entry_price)}</div><div class="sub">${data.entry_time_formatted}</div></div>
                        <div class="detail-card"><div class="label">Current Price</div><div class="value">${formatCurrency(data.current_price)}</div><div class="sub">Qty: ${data.qty}</div></div>
                        <div class="detail-card"><div class="label">Unrealized P&L</div><div class="value ${plClass}">${formatCurrency(data.unrealized_pl)}</div><div class="sub ${plClass}">${formatPercent(data.unrealized_plpc)}</div></div>
                        <div class="detail-card"><div class="label">Hold Duration</div><div class="value">${data.hold_duration}</div><div class="sub">${data.is_locked ? 'üîí Locked' : 'üîì Unlocked'}</div></div>
                    </div>
                    <div class="chart-container"><h3>üìà Price Chart</h3><iframe src="https://s.tradingview.com/widgetembed/?symbol=${symbol}&interval=D&theme=dark&style=1&timezone=exchange" style="width: 100%; height: 350px; border: none; border-radius: 4px;"></iframe></div>
                    <div class="section-box"><h3>üìä Price Levels</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px;"><span class="red">Stop: ${formatCurrency(data.stop_loss_price)}</span><span class="blue">Current: ${formatCurrency(data.current_price)}</span><span class="green">Target: ${formatCurrency(data.take_profit_price)}</span></div>
                        <div class="price-bar"><div class="price-marker stop" style="left: 0%;"></div><div class="price-marker current" style="left: ${pricePosition}%;"></div><div class="price-marker target" style="left: 100%;"></div></div>
                        <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: #6e6e6e;"><span>${data.pct_to_stop.toFixed(1)}% above stop</span><span>${data.pct_to_target.toFixed(1)}% to target</span></div>
                    </div>
                    <div class="section-box"><h3>üìù Entry Reasoning</h3><div class="content">${data.entry_reasoning.join('\n')}</div></div>
                    <div class="section-box"><h3>üéØ Exit Plan</h3><div class="content">${data.exit_plan.join('\n')}</div></div>
                    <div class="section-box"><h3>üì∞ Latest News</h3><div id="position-news" class="news-container"><div class="empty">Loading news...</div></div></div>
                    <div style="margin-top: 16px;"><button class="btn btn-secondary" onclick="toggleLock('${symbol}'); closePositionModal();">${data.is_locked ? 'üîì Unlock' : 'üîí Lock'}</button></div>
                `;
                
                // Load news
                const news = await fetchData(`/api/news/${symbol}?limit=5`);
                const newsContainer = document.getElementById('position-news');
                if (news && news.articles && news.articles.length > 0) {
                    newsContainer.innerHTML = news.articles.map(a => `<div class="news-card"><div class="news-title"><a href="${a.url}" target="_blank">${a.title}</a></div><div class="news-desc">${a.description || ''}</div><div class="news-meta"><span>${a.source}</span><span>${a.publishedAt}</span></div></div>`).join('');
                } else {
                    newsContainer.innerHTML = '<div class="empty">No recent news</div>';
                }
            } catch (error) {
                modalBody.innerHTML = `<div class="empty" style="color: #f2495c;">Error: ${error.message}</div>`;
            }
        }

        async function showSymbolDetails(symbol) {
            const positions = await fetchData('/api/positions');
            if (positions.find(p => p.symbol === symbol)) {
                return showPositionDetails(symbol);
            }
            // For non-position symbols, show basic modal with chart
            const modal = document.getElementById('position-modal');
            document.getElementById('modal-symbol').textContent = symbol;
            document.getElementById('modal-body').innerHTML = `<div class="chart-container"><h3>üìà ${symbol} Chart</h3><iframe src="https://s.tradingview.com/widgetembed/?symbol=${symbol}&interval=D&theme=dark&style=1&timezone=exchange" style="width: 100%; height: 400px; border: none; border-radius: 4px;"></iframe></div>`;
            modal.classList.add('active');
        }

        function closePositionModal() {
            document.getElementById('position-modal').classList.remove('active');
        }

        // NYSE Clock
        function updateNYSEClock() {
            const now = new Date();
            document.getElementById('nyse-time').textContent = now.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('nyse-date').textContent = now.toLocaleDateString('en-US', { timeZone: 'America/New_York', weekday: 'short', month: 'short', day: 'numeric' });
        }

        async function refreshAll() {
            await Promise.all([
                updateStatus(),
                updatePositions(),
                updateOrders(),
                updateLogs(),
                updateRebalancingStats(),
                updatePremarketCandidates(),
                updatePremarketStats()
            ]);
        }

        // Initialize
        refreshAll();
        updateNYSEClock();
        setInterval(refreshAll, 2000);
        setInterval(updateNYSEClock, 1000);

        // Modal close handlers
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePositionModal(); });
        document.getElementById('position-modal').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closePositionModal(); });
    </script>
</body>
</html>
