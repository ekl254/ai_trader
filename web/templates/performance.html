<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analytics - AI Trading</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .nav-links { display: flex; gap: 10px; margin-top: 15px; }
        .nav-links a { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 6px; transition: all 0.3s; font-weight: 600; }
        .nav-links a:hover { background: rgba(255,255,255,0.3); }
        .nav-links a.active { background: rgba(255,255,255,0.35); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .nyse-time { background: rgba(0,0,0,0.2); padding: 12px 20px; border-radius: 8px; text-align: center; }
        .nyse-time .time-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; display: block; margin-bottom: 4px; }
        .nyse-time .time-value { font-size: 24px; font-weight: 700; font-family: 'Courier New', monospace; display: block; }
        .nyse-time .time-date { font-size: 12px; opacity: 0.8; display: block; margin-top: 2px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #1e293b; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .card h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 12px; }
        .card .value { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .card .label { font-size: 14px; color: #64748b; }
        .profit { color: #10b981; }
        .loss { color: #ef4444; }
        .section { background: #1e293b; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .section h2 { font-size: 20px; margin-bottom: 20px; border-bottom: 2px solid #334155; padding-bottom: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #0f172a; font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; color: #94a3b8; }
        td { padding: 12px; border-top: 1px solid #334155; }
        .empty { text-align: center; padding: 40px; color: #64748b; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-yellow { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .recommendation { background: #1e293b; padding: 15px; border-left: 4px solid #667eea; margin: 10px 0; border-radius: 4px; }
        .recommendation.success { border-left-color: #10b981; }
        .recommendation.warning { border-left-color: #fbbf24; }
        .recommendation.error { border-left-color: #ef4444; }
        .score-bar { height: 20px; background: #334155; border-radius: 10px; overflow: hidden; margin: 8px 0; }
        .score-fill { height: 100%; background: linear-gradient(90deg, #10b981, #667eea); transition: width 0.3s; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #334155; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>üìä Performance Analytics</h1>
                <div class="nyse-time">
                    <span class="time-label">NYSE Time (ET)</span>
                    <span class="time-value" id="nyse-time">--:--:--</span>
                    <span class="time-date" id="nyse-date">Loading...</span>
                </div>
            </div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/analysis">Analysis</a>
                <a href="/performance" class="active">Performance</a>
                <a href="/optimizer">Optimizer</a>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">Overview</div>
            <div class="tab" onclick="showTab('trades')">Recent Trades</div>
            <div class="tab" onclick="showTab('scores')">Score Analysis</div>
            <div class="tab" onclick="showTab('exits')">Exit Analysis</div>
        </div>

        <div id="tab-overview">
            <div class="grid">
                <div class="card">
                    <h2>Total Trades</h2>
                    <div class="value" id="total-trades">0</div>
                    <div class="label" id="trade-period">All time</div>
                </div>
                <div class="card">
                    <h2>Win Rate</h2>
                    <div class="value" id="win-rate">0%</div>
                    <div class="label"><span id="winning-trades">0</span> wins / <span id="losing-trades">0</span> losses</div>
                </div>
                <div class="card">
                    <h2>Net Profit</h2>
                    <div class="value" id="net-profit">$0.00</div>
                    <div class="label">Profit Factor: <span id="profit-factor">0.00</span></div>
                </div>
                <div class="card">
                    <h2>Sharpe Ratio</h2>
                    <div class="value" id="sharpe-ratio">0.00</div>
                    <div class="label">Risk-adjusted returns</div>
                </div>
                <div class="card">
                    <h2>Avg Profit/Trade</h2>
                    <div class="value profit" id="avg-profit-winning">$0.00</div>
                    <div class="label">Winners</div>
                </div>
                <div class="card">
                    <h2>Avg Loss/Trade</h2>
                    <div class="value loss" id="avg-loss-losing">$0.00</div>
                    <div class="label">Losers</div>
                </div>
                <div class="card">
                    <h2>Avg Hold Time</h2>
                    <div class="value" id="avg-hold-time">0h</div>
                    <div class="label">Per trade</div>
                </div>
                <div class="card">
                    <h2>Max Drawdown</h2>
                    <div class="value loss" id="max-drawdown">$0.00</div>
                    <div class="label">Largest loss streak</div>
                </div>
            </div>

            <div class="section">
                <h2>Best & Worst Trades</h2>
                <div id="best-worst-trades"></div>
            </div>
        </div>

        <div id="tab-trades" style="display:none;">
            <div class="section">
                <h2>Recent Trades (Last 20)</h2>
                <div id="recent-trades-table"></div>
            </div>
        </div>

        <div id="tab-scores" style="display:none;">
            <div class="section">
                <h2>Score Correlation Analysis</h2>
                <div id="score-correlation"></div>
            </div>

            <div class="section">
                <h2>Performance by Score Range</h2>
                <div id="score-ranges"></div>
            </div>

            <div class="section">
                <h2>Recommendations</h2>
                <div id="recommendations"></div>
            </div>
        </div>

        <div id="tab-exits" style="display:none;">
            <div class="section">
                <h2>Performance by Exit Reason</h2>
                <div id="exit-analysis"></div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.style.display = 'none');
            // Show selected tab
            document.getElementById('tab-' + tabName).style.display = 'block';
            // Update tab styling
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        function formatPercent(value) {
            return value.toFixed(2) + '%';
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            return `${hours}h ${mins}m`;
        }

        async function loadMetrics() {
            try {
                const response = await fetch('/api/performance/metrics');
                const data = await response.json();
                
                if (data.total_trades === 0) {
                    document.getElementById('total-trades').textContent = '0';
                    document.getElementById('trade-period').textContent = 'No trades yet - start trading to see performance!';
                    return;
                }

                document.getElementById('total-trades').textContent = data.total_trades;
                document.getElementById('winning-trades').textContent = data.winning_trades;
                document.getElementById('losing-trades').textContent = data.losing_trades;
                document.getElementById('win-rate').textContent = formatPercent(data.win_rate);
                
                const netProfit = document.getElementById('net-profit');
                netProfit.textContent = formatCurrency(data.net_profit);
                netProfit.className = data.net_profit >= 0 ? 'value profit' : 'value loss';
                
                document.getElementById('profit-factor').textContent = data.profit_factor === Infinity ? '‚àû' : data.profit_factor.toFixed(2);
                document.getElementById('sharpe-ratio').textContent = data.sharpe_ratio.toFixed(2);
                document.getElementById('avg-profit-winning').textContent = formatCurrency(data.avg_profit_per_winning_trade);
                document.getElementById('avg-loss-losing').textContent = formatCurrency(data.avg_loss_per_losing_trade);
                document.getElementById('avg-hold-time').textContent = formatDuration(data.avg_hold_time_min);
                document.getElementById('max-drawdown').textContent = formatCurrency(data.max_drawdown);

                // Best/Worst trades
                const bestWorst = document.getElementById('best-worst-trades');
                bestWorst.innerHTML = `
                    <table>
                        <tr>
                            <th>Type</th>
                            <th>Symbol</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>P/L</th>
                            <th>P/L %</th>
                            <th>Score</th>
                        </tr>
                        <tr>
                            <td><span class="badge badge-green">BEST</span></td>
                            <td><strong>${data.best_trade.symbol}</strong></td>
                            <td>${formatCurrency(data.best_trade.entry_price)}</td>
                            <td>${formatCurrency(data.best_trade.exit_price)}</td>
                            <td class="profit">${formatCurrency(data.best_trade.profit_loss)}</td>
                            <td class="profit">${formatPercent(data.best_trade.profit_loss_pct)}</td>
                            <td>${data.best_trade.entry_score.composite.toFixed(1)}</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-red">WORST</span></td>
                            <td><strong>${data.worst_trade.symbol}</strong></td>
                            <td>${formatCurrency(data.worst_trade.entry_price)}</td>
                            <td>${formatCurrency(data.worst_trade.exit_price)}</td>
                            <td class="loss">${formatCurrency(data.worst_trade.profit_loss)}</td>
                            <td class="loss">${formatPercent(data.worst_trade.profit_loss_pct)}</td>
                            <td>${data.worst_trade.entry_score.composite.toFixed(1)}</td>
                        </tr>
                    </table>
                `;

            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        async function loadRecentTrades() {
            try {
                const response = await fetch('/api/performance/recent-trades');
                const trades = await response.json();
                
                const container = document.getElementById('recent-trades-table');
                
                if (trades.length === 0) {
                    container.innerHTML = '<div class="empty">No trades recorded yet</div>';
                    return;
                }

                let html = '<table><thead><tr><th>Symbol</th><th>Entry</th><th>Exit</th><th>Hold Time</th><th>P/L</th><th>P/L %</th><th>Score</th><th>Exit Reason</th></tr></thead><tbody>';
                
                for (const trade of trades) {
                    const plClass = trade.profit_loss >= 0 ? 'profit' : 'loss';
                    html += `<tr>
                        <td><strong>${trade.symbol}</strong></td>
                        <td>${formatCurrency(trade.entry_price)}</td>
                        <td>${formatCurrency(trade.exit_price)}</td>
                        <td>${formatDuration(trade.hold_duration_min)}</td>
                        <td class="${plClass}">${formatCurrency(trade.profit_loss)}</td>
                        <td class="${plClass}">${formatPercent(trade.profit_loss_pct)}</td>
                        <td>${trade.entry_score.composite.toFixed(1)}</td>
                        <td><span class="badge badge-yellow">${trade.exit_reason}</span></td>
                    </tr>`;
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load trades:', error);
            }
        }

        async function loadScoreAnalysis() {
            try {
                const response = await fetch('/api/performance/score-analysis');
                const data = await response.json();
                
                if (data.status === 'insufficient_data') {
                    document.getElementById('score-correlation').innerHTML = `
                        <div class="empty">Need at least ${data.min_required} trades for score analysis (currently have ${data.current})</div>
                    `;
                    return;
                }

                // Correlation
                document.getElementById('score-correlation').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 48px; font-weight: bold; color: ${Math.abs(data.overall_correlation) > 0.5 ? '#10b981' : '#fbbf24'};">
                            ${data.overall_correlation.toFixed(3)}
                        </div>
                        <div style="font-size: 18px; color: #94a3b8; margin-top: 10px;">
                            ${data.interpretation} correlation between entry scores and profitability
                        </div>
                        <div style="margin-top: 20px;">
                            <strong>Component Correlations:</strong><br>
                            Technical: ${data.component_correlations.technical.toFixed(3)}<br>
                            Sentiment: ${data.component_correlations.sentiment.toFixed(3)}<br>
                            Fundamental: ${data.component_correlations.fundamental.toFixed(3)}
                        </div>
                    </div>
                `;

                // Score ranges
                let rangesHtml = '<table><thead><tr><th>Score Range</th><th>Trades</th><th>Win Rate</th><th>Avg Profit %</th><th>Total Profit</th></tr></thead><tbody>';
                for (const [range, stats] of Object.entries(data.score_ranges)) {
                    rangesHtml += `<tr>
                        <td><strong>${range}</strong></td>
                        <td>${stats.count}</td>
                        <td>${formatPercent(stats.win_rate)}</td>
                        <td class="${stats.avg_profit_pct >= 0 ? 'profit' : 'loss'}">${formatPercent(stats.avg_profit_pct)}</td>
                        <td class="${stats.total_profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(stats.total_profit)}</td>
                    </tr>`;
                }
                rangesHtml += '</tbody></table>';
                document.getElementById('score-ranges').innerHTML = rangesHtml;

                // Recommendations
                let recHtml = '';
                for (const rec of data.recommendation) {
                    const type = rec.includes('‚úÖ') ? 'success' : rec.includes('‚ö†Ô∏è') ? 'warning' : 'error';
                    recHtml += `<div class="recommendation ${type}">${rec}</div>`;
                }
                document.getElementById('recommendations').innerHTML = recHtml;

            } catch (error) {
                console.error('Failed to load score analysis:', error);
            }
        }

        async function loadExitAnalysis() {
            try {
                const response = await fetch('/api/performance/exit-analysis');
                const data = await response.json();
                
                if (data.message) {
                    document.getElementById('exit-analysis').innerHTML = `<div class="empty">${data.message}</div>`;
                    return;
                }

                let html = '<table><thead><tr><th>Exit Reason</th><th>Trades</th><th>Win Rate</th><th>Avg Profit</th><th>Avg Profit %</th><th>Total Profit</th></tr></thead><tbody>';
                
                for (const [reason, stats] of Object.entries(data)) {
                    html += `<tr>
                        <td><span class="badge badge-yellow">${reason}</span></td>
                        <td>${stats.count}</td>
                        <td>${formatPercent(stats.win_rate)}</td>
                        <td class="${stats.avg_profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(stats.avg_profit)}</td>
                        <td class="${stats.avg_profit_pct >= 0 ? 'profit' : 'loss'}">${formatPercent(stats.avg_profit_pct)}</td>
                        <td class="${stats.total_profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(stats.total_profit)}</td>
                    </tr>`;
                }
                
                html += '</tbody></table>';
                document.getElementById('exit-analysis').innerHTML = html;

            } catch (error) {
                console.error('Failed to load exit analysis:', error);
            }
        }

        // Load all data
        loadMetrics();
        loadRecentTrades();
        loadScoreAnalysis();
        loadExitAnalysis();

        // Auto-refresh every 5 seconds for near real-time updates
        setInterval(() => {
            loadMetrics();
            loadRecentTrades();
            loadScoreAnalysis();
            loadExitAnalysis();
        }, 5000);

        // NYSE Time - Update every second using client-side calculation
        function updateNYSETimeLocal() {
            const now = new Date();
            const options = { 
                timeZone: 'America/New_York',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const dateOptions = {
                timeZone: 'America/New_York',
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            };
            document.getElementById('nyse-time').textContent = now.toLocaleTimeString('en-US', options);
            document.getElementById('nyse-date').textContent = now.toLocaleDateString('en-US', dateOptions);
        }
        updateNYSETimeLocal();
        setInterval(updateNYSETimeLocal, 1000);
    </script>
</body>
</html>
