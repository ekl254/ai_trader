<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Optimizer - AI Trading</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #111217; 
            color: #d8d9da; 
            padding: 20px; 
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #1f1f1f;
            border: 1px solid #343436;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .nav-brand { font-size: 18px; font-weight: 600; color: #ff9830; }
        .nav-links { display: flex; gap: 8px; }
        .nav-links a {
            padding: 8px 16px;
            color: #d8d9da;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            background: transparent;
        }
        .nav-links a:hover { background: #343436; color: #fff; }
        .nav-links a.active { background: #5794f2; color: #fff; }
        .nav-links a.logout { background: rgba(242, 73, 92, 0.2); color: #f2495c; }
        .nav-links a.logout:hover { background: rgba(242, 73, 92, 0.3); }
        
        /* Header Info Bar */
        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #1f1f1f;
            border: 1px solid #343436;
            border-radius: 4px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .page-title { font-size: 24px; font-weight: 600; color: #fff; }
        .regime-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #262628;
            border-radius: 4px;
        }
        .regime-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #8e8e8e; }
        .regime-value { font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 4px; }
        .regime-params { font-size: 11px; color: #8e8e8e; }
        .regime-strong_bull { background: #73bf69; color: #111217; }
        .regime-bull { background: rgba(115, 191, 105, 0.7); color: #111217; }
        .regime-neutral { background: #8e8e8e; color: #111217; }
        .regime-bear { background: #ff9830; color: #111217; }
        .regime-strong_bear { background: #f2495c; color: #fff; }
        .regime-high_volatility { background: #b877d9; color: #fff; }
        .regime-unknown { background: #343436; color: #d8d9da; }
        .nyse-time { text-align: right; }
        .nyse-time .time-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #8e8e8e; display: block; }
        .nyse-time .time-value { font-size: 20px; font-weight: 600; font-family: 'Roboto Mono', monospace; color: #fff; display: block; }
        .nyse-time .time-date { font-size: 12px; color: #8e8e8e; display: block; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #1f1f1f;
            border: 1px solid #343436;
            border-radius: 4px;
            padding: 16px;
        }
        .stat-card .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8e8e8e;
            margin-bottom: 8px;
        }
        .stat-card .stat-value {
            font-size: 26px;
            font-weight: 600;
            color: #fff;
        }
        .stat-card .stat-sub {
            font-size: 12px;
            color: #8e8e8e;
            margin-top: 4px;
        }
        .stat-value.green, .profit { color: #73bf69; }
        .stat-value.red, .loss { color: #f2495c; }
        .stat-value.yellow, .warning { color: #ff9830; }

        /* Panel */
        .panel {
            background: #1f1f1f;
            border: 1px solid #343436;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .panel-header {
            padding: 12px 16px;
            background: #262628;
            border-bottom: 1px solid #343436;
        }
        .panel-title { font-size: 14px; font-weight: 600; color: #d8d9da; }
        .panel-body { padding: 16px; }

        /* Two Column Layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1000px) {
            .two-col { grid-template-columns: 1fr; }
        }

        /* Comparison Grid */
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .config-box {
            background: #111217;
            padding: 20px;
            border-radius: 4px;
            border: 1px solid #343436;
        }
        .config-box.optimal { border-color: #73bf69; }
        .config-box.simulated { border-color: #5794f2; }
        .config-box h3 { margin-bottom: 16px; font-size: 15px; }
        .config-box h3.current { color: #8e8e8e; }
        .config-box h3.optimal { color: #73bf69; }
        .config-box h3.simulated { color: #5794f2; }
        .config-item { margin: 12px 0; font-size: 13px; }
        .config-item strong { color: #d8d9da; }

        /* Sliders */
        .slider-container { margin: 16px 0; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #343436;
            outline: none;
            -webkit-appearance: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #5794f2;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #73bf69; color: #111217; }
        .btn-primary:hover { background: #5fa854; }
        .btn-secondary { background: #5794f2; color: #fff; }
        .btn-secondary:hover { background: #4080e0; }
        .btn-outline { background: transparent; border: 1px solid #343436; color: #d8d9da; }
        .btn-outline:hover { background: #343436; }

        /* Info Icon */
        .info-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            background: #343436;
            color: #d8d9da;
            border-radius: 50%;
            text-align: center;
            line-height: 14px;
            font-size: 10px;
            margin-left: 6px;
            cursor: help;
            position: relative;
        }
        .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #262628;
            color: #d8d9da;
            padding: 12px 14px;
            border-radius: 4px;
            font-size: 12px;
            width: 260px;
            z-index: 100;
            border: 1px solid #343436;
            line-height: 1.5;
            font-weight: normal;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #262628 transparent transparent transparent;
        }
        .info-icon:hover .tooltip { visibility: visible; }

        /* Recommendation */
        .recommendation {
            background: #262628;
            padding: 14px;
            border-left: 3px solid #5794f2;
            margin: 10px 0;
            border-radius: 0 4px 4px 0;
        }
        .recommendation h3 { margin-bottom: 8px; font-size: 14px; }
        .recommendation.high { border-left-color: #f2495c; }
        .recommendation.medium { border-left-color: #ff9830; }
        .recommendation.low { border-left-color: #73bf69; }

        .loading { text-align: center; padding: 40px; color: #8e8e8e; }
        .loading h2 { margin-bottom: 10px; }
        
        /* Live indicator */
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #8e8e8e;
        }
        .live-indicator .dot {
            width: 8px;
            height: 8px;
            background: #73bf69;
            border-radius: 50%;
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left;
            padding: 10px 12px;
            background: #262628;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            color: #8e8e8e;
            border-bottom: 1px solid #343436;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #343436;
            font-size: 13px;
        }
        tbody tr:hover { background: rgba(87, 148, 242, 0.08); }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 16px;
        }

        /* Simulation Preview Box */
        .sim-preview {
            background: linear-gradient(135deg, rgba(87, 148, 242, 0.1), rgba(87, 148, 242, 0.05));
            border: 1px solid #5794f2;
            border-radius: 4px;
            padding: 16px;
            margin-top: 16px;
        }
        .sim-preview h4 {
            color: #5794f2;
            margin-bottom: 12px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sim-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .sim-stat {
            text-align: center;
        }
        .sim-stat .value {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }
        .sim-stat .label {
            font-size: 11px;
            color: #8e8e8e;
            margin-top: 4px;
        }

        /* Notification */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="top-nav">
            <div class="nav-brand">AI Trader</div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/analysis">Analysis</a>
                <a href="/performance">Performance</a>
                <a href="/optimizer" class="active">Optimizer</a>
                <a href="/metrics-view">Metrics</a>
                <a href="/grafana">Grafana</a>
                <a href="/logout" class="logout">Logout</a>
            </div>
            <div class="live-indicator">
                <div class="dot"></div>
                <span>Live</span>
            </div>
        </nav>

        <!-- Info Bar -->
        <div class="info-bar">
            <div class="page-title">Strategy Optimizer</div>
            <div class="regime-indicator" id="regime-indicator" title="Current market regime and adaptive trading parameters">
                <span class="regime-label">Regime</span>
                <span class="regime-value regime-unknown" id="regime-value">Loading...</span>
                <span class="regime-params" id="regime-params">SL: --% | TP: --% | Min: --</span>
            </div>
            <div class="nyse-time">
                <span class="time-label">NYSE Time (ET)</span>
                <span class="time-value" id="nyse-time">--:--:--</span>
                <span class="time-date" id="nyse-date">Loading...</span>
            </div>
        </div>

        <div id="loading" class="loading">
            <h2>Analyzing historical performance...</h2>
            <p>Please wait while we optimize your strategy</p>
        </div>

        <div id="content" style="display:none;">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Current Win Rate</div>
                    <div class="stat-value" id="current-win-rate">0%</div>
                    <div class="stat-sub">Based on <span id="total-trades">0</span> trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Sharpe Ratio</div>
                    <div class="stat-value" id="current-sharpe">0.00</div>
                    <div class="stat-sub">Risk-adjusted returns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-value" id="profit-factor">0.00</div>
                    <div class="stat-sub">Winners / Losers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Projected Improvement</div>
                    <div class="stat-value green" id="projected-improvement">0%</div>
                    <div class="stat-sub">With optimal config</div>
                </div>
            </div>

            <div class="two-col">
                <!-- Left Column: Simulator -->
                <div>
                    <!-- Weight Simulator -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Live Strategy Simulator</div>
                        </div>
                        <div class="panel-body">
                            <div class="slider-container">
                                <div class="slider-label">
                                    <span>Technical Weight: <strong id="tech-weight-val">40%</strong></span>
                                    <span class="info-icon">?
                                        <span class="tooltip"><strong>Technical Analysis</strong><br>Price patterns, RSI, moving averages, volume analysis.</span>
                                    </span>
                                </div>
                                <input type="range" min="0" max="70" value="40" class="slider" id="tech-weight">
                            </div>

                            <div class="slider-container">
                                <div class="slider-label">
                                    <span>Sentiment Weight: <strong id="sent-weight-val">30%</strong></span>
                                    <span class="info-icon">?
                                        <span class="tooltip"><strong>News Sentiment</strong><br>FinBERT analysis of recent news articles.</span>
                                    </span>
                                </div>
                                <input type="range" min="0" max="70" value="30" class="slider" id="sent-weight">
                            </div>

                            <div class="slider-container">
                                <div class="slider-label">
                                    <span>Fundamental Weight: <strong id="fund-weight-val">30%</strong></span>
                                    <span id="weight-sum" class="warning" style="margin-left: auto;">Total: 100%</span>
                                </div>
                                <input type="range" min="0" max="70" value="30" class="slider" id="fund-weight">
                            </div>

                            <div class="slider-container" style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #343436;">
                                <div class="slider-label">
                                    <span>Min Score Threshold: <strong id="threshold-val">55</strong></span>
                                    <span class="info-icon">?
                                        <span class="tooltip"><strong>Entry Threshold</strong><br>Minimum composite score to buy. Higher = fewer but better trades.</span>
                                    </span>
                                </div>
                                <input type="range" min="50" max="85" step="2.5" value="55" class="slider" id="threshold-slider">
                            </div>

                            <!-- Live Simulation Preview -->
                            <div class="sim-preview" id="sim-preview">
                                <h4>Simulated Performance (based on historical trades)</h4>
                                <div class="sim-grid">
                                    <div class="sim-stat">
                                        <div class="value" id="sim-win-rate">--</div>
                                        <div class="label">Win Rate</div>
                                    </div>
                                    <div class="sim-stat">
                                        <div class="value" id="sim-trades">--</div>
                                        <div class="label">Qualifying Trades</div>
                                    </div>
                                    <div class="sim-stat">
                                        <div class="value" id="sim-avg-profit">--</div>
                                        <div class="label">Avg Profit %</div>
                                    </div>
                                    <div class="sim-stat">
                                        <div class="value" id="sim-expected">--</div>
                                        <div class="label">Expected Value</div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 16px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="applySettings()">Apply Changes</button>
                                <button class="btn btn-outline" onclick="resetToOptimal()">Use Optimal</button>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Optimization Recommendations</div>
                        </div>
                        <div class="panel-body" id="recommendations"></div>
                    </div>
                </div>

                <!-- Right Column: Analysis -->
                <div>
                    <!-- Config Comparison -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Current vs Optimal Configuration</div>
                        </div>
                        <div class="panel-body">
                            <div class="comparison">
                                <div class="config-box">
                                    <h3 class="current">Current Config</h3>
                                    <div class="config-item">
                                        <strong>Weights:</strong><br>
                                        Tech: <span id="current-tech">40%</span> | 
                                        Sent: <span id="current-sent">30%</span> | 
                                        Fund: <span id="current-fund">30%</span>
                                    </div>
                                    <div class="config-item">
                                        <strong>Threshold:</strong> <span id="current-threshold">55</span>
                                    </div>
                                    <div class="config-item">
                                        <strong>Win Rate:</strong> <span id="current-expected-wr">--</span>
                                    </div>
                                </div>
                                <div class="config-box optimal">
                                    <h3 class="optimal">Optimal Config</h3>
                                    <div class="config-item">
                                        <strong>Weights:</strong><br>
                                        Tech: <span id="optimal-tech">40%</span> | 
                                        Sent: <span id="optimal-sent">30%</span> | 
                                        Fund: <span id="optimal-fund">30%</span>
                                    </div>
                                    <div class="config-item">
                                        <strong>Threshold:</strong> <span id="optimal-threshold" class="profit">72.5</span>
                                    </div>
                                    <div class="config-item">
                                        <strong>Win Rate:</strong> <span id="optimal-expected-wr" class="profit">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Score Range Analysis -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Performance by Score Range</div>
                        </div>
                        <div class="panel-body">
                            <table id="score-range-table">
                                <thead>
                                    <tr>
                                        <th>Score Range</th>
                                        <th>Trades</th>
                                        <th>Win Rate</th>
                                        <th>Avg Profit</th>
                                        <th>Total P/L</th>
                                    </tr>
                                </thead>
                                <tbody id="score-range-body">
                                    <tr><td colspan="5" style="text-align: center; color: #6e6e6e;">Loading...</td></tr>
                                </tbody>
                            </table>
                            <div class="chart-container">
                                <canvas id="scoreRangeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Threshold Analysis Chart -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Threshold vs Win Rate Trade-off</div>
                        </div>
                        <div class="panel-body">
                            <div class="chart-container" style="height: 180px;">
                                <canvas id="thresholdChart"></canvas>
                            </div>
                            <p style="font-size: 11px; color: #6e6e6e; margin-top: 12px; text-align: center;">
                                Higher threshold = fewer trades but better win rate. Find the sweet spot.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let optimizerData = null;
        let historicalTrades = [];
        let scoreRangeChart = null;
        let thresholdChart = null;
        let optimalConfig = null;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, options);
            if (response.status === 401) {
                window.location.href = '/login';
                throw new Error('Authentication required');
            }
            return response;
        }

        async function loadCurrentWeights() {
            try {
                const response = await fetchWithAuth('/api/config/weights');
                const data = await response.json();
                
                document.getElementById('tech-weight').value = data.weights.technical * 100;
                document.getElementById('sent-weight').value = data.weights.sentiment * 100;
                document.getElementById('fund-weight').value = data.weights.fundamental * 100;
                document.getElementById('threshold-slider').value = data.threshold;
                updateSliderValues();
            } catch (error) {
                console.error('Failed to load current weights:', error);
            }
        }

        async function loadHistoricalTrades() {
            try {
                const response = await fetchWithAuth('/api/performance/recent-trades?limit=100');
                historicalTrades = await response.json();
                if (!Array.isArray(historicalTrades)) historicalTrades = [];
            } catch (error) {
                console.error('Failed to load trades:', error);
                historicalTrades = [];
            }
        }

        async function loadOptimizer() {
            try {
                const response = await fetchWithAuth('/api/optimizer/analyze');
                const data = await response.json();
                optimizerData = data;
                
                document.getElementById('loading').style.display = 'none';
                
                if (data.status === 'insufficient_data') {
                    document.getElementById('content').style.display = 'block';
                    document.getElementById('recommendations').innerHTML = `
                        <div class="recommendation high">
                            <h3>More Data Needed</h3>
                            <p>Optimizer requires at least ${data.min_required} trades for reliable recommendations.</p>
                            <p>Current: ${data.current_trades} trades | Needed: ${data.trades_needed} more</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('content').style.display = 'block';
                
                // Store optimal config for reset button
                optimalConfig = data.optimal_config;
                
                // Current performance
                document.getElementById('current-win-rate').textContent = data.current_performance.win_rate.toFixed(1) + '%';
                document.getElementById('current-sharpe').textContent = data.current_performance.sharpe_ratio.toFixed(2);
                document.getElementById('profit-factor').textContent = data.current_performance.profit_factor === Infinity ? '∞' : data.current_performance.profit_factor.toFixed(2);
                document.getElementById('total-trades').textContent = data.current_performance.total_trades;
                document.getElementById('projected-improvement').textContent = '+' + data.projected_improvement.combined_estimate.toFixed(1) + '%';
                
                // Current config
                const currentWeights = data.current_config.weights;
                document.getElementById('current-tech').textContent = (currentWeights.technical * 100).toFixed(0) + '%';
                document.getElementById('current-sent').textContent = (currentWeights.sentiment * 100).toFixed(0) + '%';
                document.getElementById('current-fund').textContent = (currentWeights.fundamental * 100).toFixed(0) + '%';
                document.getElementById('current-threshold').textContent = data.current_config.threshold;
                
                // Optimal config
                const optimalWeights = data.optimal_config.weights;
                document.getElementById('optimal-tech').textContent = (optimalWeights.technical * 100).toFixed(0) + '%';
                document.getElementById('optimal-sent').textContent = (optimalWeights.sentiment * 100).toFixed(0) + '%';
                document.getElementById('optimal-fund').textContent = (optimalWeights.fundamental * 100).toFixed(0) + '%';
                document.getElementById('optimal-threshold').textContent = data.optimal_config.threshold;
                
                // Expected Win Rates
                const currentExpWr = data.current_config.expected_win_rate;
                const optimalExpWr = data.optimal_config.expected_win_rate;
                
                if (currentExpWr && currentExpWr.win_rate !== null) {
                    document.getElementById('current-expected-wr').textContent = currentExpWr.win_rate.toFixed(1) + '% (' + currentExpWr.sample_size + ')';
                }
                if (optimalExpWr && optimalExpWr.win_rate !== null) {
                    document.getElementById('optimal-expected-wr').textContent = optimalExpWr.win_rate.toFixed(1) + '% (' + optimalExpWr.sample_size + ')';
                }
                
                // Recommendations
                let recHtml = '';
                for (const rec of data.recommendations) {
                    recHtml += `
                        <div class="recommendation ${rec.priority}">
                            <h3>[${rec.priority.toUpperCase()}] ${rec.title}</h3>
                            <p>${rec.description}</p>
                            ${rec.changes ? '<p style="margin-top: 8px; font-size: 12px;"><strong>Changes:</strong> ' + rec.changes.join(' | ') + '</p>' : ''}
                        </div>
                    `;
                }
                document.getElementById('recommendations').innerHTML = recHtml || '<p style="color: #73bf69;">Your strategy is performing well!</p>';
                
                // Score range analysis
                if (data.score_analysis && data.score_analysis.score_ranges) {
                    renderScoreRangeTable(data.score_analysis.score_ranges);
                    renderScoreRangeChart(data.score_analysis.score_ranges);
                }
                
                // Threshold chart (simulated data)
                renderThresholdChart();
                
                // Initial simulation
                simulatePerformance();
                
            } catch (error) {
                console.error('Failed to load optimizer:', error);
                document.getElementById('loading').innerHTML = '<h2 style="color: #f2495c;">Error loading optimizer</h2><p>' + error + '</p>';
            }
        }

        function renderScoreRangeTable(scoreRanges) {
            const tbody = document.getElementById('score-range-body');
            let html = '';
            
            for (const [range, stats] of Object.entries(scoreRanges)) {
                const profitClass = stats.total_profit >= 0 ? 'profit' : 'loss';
                html += `
                    <tr>
                        <td><strong>${range}</strong></td>
                        <td>${stats.count}</td>
                        <td>${stats.win_rate.toFixed(1)}%</td>
                        <td class="${stats.avg_profit_pct >= 0 ? 'profit' : 'loss'}">${stats.avg_profit_pct.toFixed(2)}%</td>
                        <td class="${profitClass}">$${stats.total_profit.toFixed(0)}</td>
                    </tr>
                `;
            }
            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: #6e6e6e;">No data</td></tr>';
        }

        function renderScoreRangeChart(scoreRanges) {
            const ctx = document.getElementById('scoreRangeChart').getContext('2d');
            
            const labels = Object.keys(scoreRanges);
            const winRates = labels.map(k => scoreRanges[k].win_rate);
            const profits = labels.map(k => scoreRanges[k].avg_profit_pct);
            
            if (scoreRangeChart) scoreRangeChart.destroy();
            
            scoreRangeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Win Rate %',
                        data: winRates,
                        backgroundColor: 'rgba(115, 191, 105, 0.7)',
                        borderColor: '#73bf69',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            grid: { color: '#343436' },
                            ticks: { color: '#8e8e8e' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#8e8e8e' }
                        }
                    }
                }
            });
        }

        function renderThresholdChart() {
            const ctx = document.getElementById('thresholdChart').getContext('2d');
            
            // Simulate threshold data
            const thresholds = [50, 55, 60, 65, 70, 75, 80];
            const winRates = [];
            const tradeCounts = [];
            
            for (const threshold of thresholds) {
                const qualifying = historicalTrades.filter(t => 
                    t.entry_score && t.entry_score.composite >= threshold
                );
                const winners = qualifying.filter(t => t.profit_loss > 0);
                winRates.push(qualifying.length > 0 ? (winners.length / qualifying.length * 100) : 0);
                tradeCounts.push(qualifying.length);
            }
            
            if (thresholdChart) thresholdChart.destroy();
            
            thresholdChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: thresholds.map(t => t.toString()),
                    datasets: [{
                        label: 'Win Rate %',
                        data: winRates,
                        borderColor: '#73bf69',
                        backgroundColor: 'rgba(115, 191, 105, 0.1)',
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y'
                    }, {
                        label: 'Trade Count',
                        data: tradeCounts,
                        borderColor: '#5794f2',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { 
                            display: true,
                            labels: { color: '#8e8e8e', boxWidth: 12 }
                        }
                    },
                    scales: {
                        y: { 
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#343436' },
                            ticks: { color: '#73bf69' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: { color: '#5794f2' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#8e8e8e' }
                        }
                    }
                }
            });
        }

        function updateSliderValues() {
            const tech = parseInt(document.getElementById('tech-weight').value);
            const sent = parseInt(document.getElementById('sent-weight').value);
            const fund = parseInt(document.getElementById('fund-weight').value);
            const threshold = parseFloat(document.getElementById('threshold-slider').value);
            
            document.getElementById('tech-weight-val').textContent = tech + '%';
            document.getElementById('sent-weight-val').textContent = sent + '%';
            document.getElementById('fund-weight-val').textContent = fund + '%';
            document.getElementById('threshold-val').textContent = threshold;
            
            const sum = tech + sent + fund;
            const sumEl = document.getElementById('weight-sum');
            sumEl.textContent = 'Total: ' + sum + '%';
            sumEl.style.color = sum === 100 ? '#73bf69' : '#f2495c';
            
            // Update simulation
            simulatePerformance();
        }

        function simulatePerformance() {
            if (!historicalTrades.length) {
                document.getElementById('sim-win-rate').textContent = '--';
                document.getElementById('sim-trades').textContent = '--';
                document.getElementById('sim-avg-profit').textContent = '--';
                document.getElementById('sim-expected').textContent = '--';
                return;
            }
            
            const tech = parseInt(document.getElementById('tech-weight').value) / 100;
            const sent = parseInt(document.getElementById('sent-weight').value) / 100;
            const fund = parseInt(document.getElementById('fund-weight').value) / 100;
            const threshold = parseFloat(document.getElementById('threshold-slider').value);
            
            // Recalculate composite scores and filter
            const qualifying = [];
            for (const trade of historicalTrades) {
                if (!trade.entry_score) continue;
                
                const newComposite = (
                    (trade.entry_score.technical || 50) * tech +
                    (trade.entry_score.sentiment || 50) * sent +
                    (trade.entry_score.fundamental || 50) * fund
                );
                
                if (newComposite >= threshold) {
                    qualifying.push({
                        ...trade,
                        newComposite
                    });
                }
            }
            
            if (qualifying.length < 3) {
                document.getElementById('sim-win-rate').textContent = '--';
                document.getElementById('sim-trades').textContent = qualifying.length;
                document.getElementById('sim-avg-profit').textContent = '--';
                document.getElementById('sim-expected').textContent = '--';
                return;
            }
            
            const winners = qualifying.filter(t => t.profit_loss > 0);
            const winRate = (winners.length / qualifying.length * 100);
            const avgProfit = qualifying.reduce((sum, t) => sum + t.profit_loss_pct, 0) / qualifying.length;
            
            const avgWinner = winners.length > 0 
                ? winners.reduce((sum, t) => sum + t.profit_loss_pct, 0) / winners.length 
                : 0;
            const losers = qualifying.filter(t => t.profit_loss <= 0);
            const avgLoser = losers.length > 0 
                ? losers.reduce((sum, t) => sum + t.profit_loss_pct, 0) / losers.length 
                : 0;
            const expectedValue = (winRate / 100 * avgWinner) + ((100 - winRate) / 100 * avgLoser);
            
            const winRateEl = document.getElementById('sim-win-rate');
            winRateEl.textContent = winRate.toFixed(1) + '%';
            winRateEl.style.color = winRate >= 55 ? '#73bf69' : winRate >= 45 ? '#ff9830' : '#f2495c';
            
            document.getElementById('sim-trades').textContent = qualifying.length;
            
            const avgProfitEl = document.getElementById('sim-avg-profit');
            avgProfitEl.textContent = avgProfit.toFixed(2) + '%';
            avgProfitEl.style.color = avgProfit >= 0 ? '#73bf69' : '#f2495c';
            
            const expectedEl = document.getElementById('sim-expected');
            expectedEl.textContent = expectedValue.toFixed(2) + '%';
            expectedEl.style.color = expectedValue >= 0 ? '#73bf69' : '#f2495c';
        }

        function resetToOptimal() {
            if (!optimalConfig) return;
            
            document.getElementById('tech-weight').value = optimalConfig.weights.technical * 100;
            document.getElementById('sent-weight').value = optimalConfig.weights.sentiment * 100;
            document.getElementById('fund-weight').value = optimalConfig.weights.fundamental * 100;
            document.getElementById('threshold-slider').value = optimalConfig.threshold;
            updateSliderValues();
        }

        async function applySettings() {
            const tech = parseInt(document.getElementById('tech-weight').value) / 100;
            const sent = parseInt(document.getElementById('sent-weight').value) / 100;
            const fund = parseInt(document.getElementById('fund-weight').value) / 100;
            const threshold = parseFloat(document.getElementById('threshold-slider').value);
            
            const sum = tech + sent + fund;
            if (Math.abs(sum - 1.0) > 0.01) {
                showNotification('Weights must sum to 100%!', 'error');
                return;
            }
            
            try {
                const response = await fetchWithAuth('/api/config/weights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ technical: tech, sentiment: sent, fundamental: fund, threshold: threshold })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    showNotification('Settings applied successfully!', 'success');
                    setTimeout(loadOptimizer, 500);
                } else {
                    showNotification('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }
        
        function showNotification(message, type) {
            const existing = document.getElementById('notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 4px;
                font-weight: 600; z-index: 10000; animation: slideIn 0.3s ease; max-width: 400px; font-size: 13px;
                background: ${type === 'success' ? '#73bf69' : '#f2495c'}; color: ${type === 'success' ? '#111217' : '#fff'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Event listeners
        document.getElementById('tech-weight').addEventListener('input', updateSliderValues);
        document.getElementById('sent-weight').addEventListener('input', updateSliderValues);
        document.getElementById('fund-weight').addEventListener('input', updateSliderValues);
        document.getElementById('threshold-slider').addEventListener('input', updateSliderValues);

        // Initialize
        async function init() {
            await loadHistoricalTrades();
            await loadCurrentWeights();
            await loadOptimizer();
        }
        init();

        // NYSE Time
        function updateNYSETimeLocal() {
            const now = new Date();
            const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const dateOptions = { timeZone: 'America/New_York', weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('nyse-time').textContent = now.toLocaleTimeString('en-US', options);
            document.getElementById('nyse-date').textContent = now.toLocaleDateString('en-US', dateOptions);
        }
        updateNYSETimeLocal();
        setInterval(updateNYSETimeLocal, 1000);

        // Regime indicator
        async function updateRegime() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                if (data.regime) {
                    const regime = data.regime;
                    const regimeValue = document.getElementById('regime-value');
                    const regimeParams = document.getElementById('regime-params');
                    
                    const regimeDisplay = {
                        'strong_bull': 'STRONG BULL', 'bull': 'BULL', 'neutral': 'NEUTRAL',
                        'bear': 'BEAR', 'strong_bear': 'STRONG BEAR', 'high_volatility': 'HIGH VOL'
                    };
                    
                    const regimeName = regime.regime || 'unknown';
                    regimeValue.textContent = regimeDisplay[regimeName] || regimeName.toUpperCase();
                    regimeValue.className = `regime-value regime-${regimeName}`;
                    
                    const slPct = ((regime.stop_loss_pct || 0.03) * 100).toFixed(0);
                    const tpPct = ((regime.take_profit_pct || 0.08) * 100).toFixed(0);
                    const minScore = regime.min_score || 70;
                    regimeParams.textContent = `SL: ${slPct}% | TP: ${tpPct}% | Min: ${minScore}`;
                }
            } catch (e) { console.error('Regime fetch error:', e); }
        }
        updateRegime();
        setInterval(updateRegime, 10000);

        // Auto-refresh stats every 30 seconds (lightweight updates)
        async function refreshStats() {
            try {
                // Refresh historical trades for simulation
                await loadHistoricalTrades();
                simulatePerformance();
                
                // Update current performance from API
                const response = await fetchWithAuth('/api/performance/metrics');
                const data = await response.json();
                
                if (data && !data.error && data.total_trades > 0) {
                    document.getElementById('current-win-rate').textContent = data.win_rate.toFixed(1) + '%';
                    document.getElementById('current-sharpe').textContent = data.sharpe_ratio.toFixed(2);
                    document.getElementById('profit-factor').textContent = data.profit_factor === Infinity ? '∞' : data.profit_factor.toFixed(2);
                    document.getElementById('total-trades').textContent = data.total_trades;
                }
            } catch (error) {
                console.error('Stats refresh error:', error);
            }
        }
        
        // Refresh stats every 30 seconds
        setInterval(refreshStats, 30000);
    </script>
</body>
</html>
